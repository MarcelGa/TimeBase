name: Build Providers

on:
  push:
    branches: [master]
    paths:
      - 'providers/**'
      - 'src/docker/**'
      - '.github/workflows/build-providers.yml'
  pull_request:
    branches: [master]
    paths:
      - 'providers/**'
      - 'src/docker/**'
      - '.github/workflows/build-providers.yml'

jobs:
  build-providers:
    name: Build Provider Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [minimal-provider, yahoo-finance, ccxt]
        include:
          - provider: minimal-provider
            context: .
            dockerfile: ./providers/examples/minimal-provider/Dockerfile
          - provider: yahoo-finance
            context: .
            dockerfile: ./providers/yahoo-finance/Dockerfile
          - provider: ccxt
            context: .
            dockerfile: ./providers/ccxt/Dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build provider image
        run: |
          docker build -f ${{ matrix.dockerfile }} -t timebase/${{ matrix.provider }}:test .
      
      - name: Test provider image
        run: |
          # Test that the image was built and can start (with 10 second timeout)
          timeout 10s docker run --rm timebase/${{ matrix.provider }}:test || true
          echo "Provider image test completed"

  test-providers:
    name: Test Provider Functionality
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [yahoo-finance, ccxt]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run provider-specific tests
        uses: ./providers/${{ matrix.provider }}/.github/actions/test
        with:
          python-version: '3.11'
