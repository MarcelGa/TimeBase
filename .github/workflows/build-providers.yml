name: Build Providers

on:
  push:
    branches: [master]
    paths:
      - 'providers/**'
      - 'src/docker/**'
      - '.github/workflows/build-providers.yml'
  pull_request:
    branches: [master]
    paths:
      - 'providers/**'
      - 'src/docker/**'
      - '.github/workflows/build-providers.yml'

jobs:
  build-providers:
    name: Build Provider Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        provider: [minimal-provider, yahoo-finance, ccxt]
        include:
          - provider: minimal-provider
            context: .
            dockerfile: ./providers/examples/minimal-provider/Dockerfile
          - provider: yahoo-finance
            context: .
            dockerfile: ./providers/yahoo-finance/Dockerfile
          - provider: ccxt
            context: .
            dockerfile: ./providers/ccxt/Dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build provider image
        run: |
          docker build -f ${{ matrix.dockerfile }} -t timebase/${{ matrix.provider }}:test .
      
      - name: Test provider image
        run: |
          # Verify the image was built and container can start
          # Use --init to ensure proper signal handling and faster shutdown
          timeout --signal=KILL 5s docker run --rm --init timebase/${{ matrix.provider }}:test || true
          echo "Provider image test completed"

  test-yahoo-finance:
    name: Test Yahoo Finance Provider
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run provider tests
        uses: ./providers/yahoo-finance/.github/actions/test
        with:
          python-version: '3.11'

  # CCXT tests are skipped in CI due to Binance API geo-restrictions (HTTP 451)
  # Run these tests locally or use a VPN/proxy to test CCXT provider
  # test-ccxt:
  #   name: Test CCXT Provider
  #   runs-on: ubuntu-latest
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Run provider tests
  #       uses: ./providers/ccxt/.github/actions/test
  #       with:
  #         python-version: '3.11'
